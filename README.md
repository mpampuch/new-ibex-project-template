# new-ibex-project-template
This repository contiains all the necessary files and instructions to initialize a new directory on the KAUST IBEX for a data analysis project.

## Cloning this directory into IBEX

On IBEX, all work should be performed in your work folder. This is found at `/ibex/user/YOUR_KAUST_USERNAME`
```bash
# Change into your work folder
cd /ibex/user/YOUR_KAUST_USERNAME

# Create a directory for your data analysis project and change into it
mkdir YOUR_PROJECT_NAME
cd YOUR_PROJECT_NAME

# Copy all the files in this repository into your new project directory
git clone --depth 1 https://github.com/mpampuch/new-ibex-project-template temp_folder && rsync -av temp_folder/ . && rm -rf temp_folder
```
Now all the files and programs you to complete your specific data analysis project will be stored in the folder you created. Copy or move all the data you need into this folder to make sure you stay organized.

## Activating a conda environement

Conda is used for managing your programs and software packages. You need to make sure you are able to activate the enviroment in the `env` folder found in your new project for the following steps to work. The `env` folder is created using the the `environment.yml` file. Modify this file to include any softwares or packages that you will need to perform your data analysis. To find out how to correctly install the tool that you need, search for it on https://anaconda.org/ and copy the name of the tool exactly as it appears on the website into the `dependencies:` section of the `environment.yml` file. Once you have all the tools you need to conduct your analysis, run the following commands.

```bash
# Make sure you are in your new project folder before starting
conda activate mamba
mamba env create --prefix ./env --file environment.yml --force
conda activate "$(pwd)/env"
```

If you don't have a conda environment called mamba, run the following code first before retrying the above

```bash
conda create --name mamba
conda activate mamba
conda install -c conda-forge mamba
conda deactivate mamba
```

If that still doesn't work, make sure you have conda installed. Try to troubleshoot using this video: https://www.youtube.com/watch?v=X-W7aVXH3_w

**Side note:** This is the best video on what conda is and how and why to use it. It's 3h long and very dry but it's extremely useful in order to know how to effectively stay organized before analyzing large data https://www.youtube.com/watch?v=GW9_AXz-G5s

## Activating VSCode (code-server)

Trying to do data science projects in your Terminal will make you go insane. Using code-server (VSCode for a remote machine) will make writing code and working on a remote machine 10x easier.

To activate run

```bash
# Make sure you are in your project folder before starting

# Activate your conda environment
conda activate "$(pwd)/env"

# Run the script to launch code-server
sbatch bin/launch-code-server.sbatch

# Monitor your SLURM process until your job starts running
watch -d -n 10 squeue -u YOUR_IBEX_USERNAME
# Once your job is running, continue with the following steps
# Note: You can use Ctrl + C (on Mac) to get out of this view

# code-server should now be activating. This should be almost instantaneous or very quick. Monitor it (and view the output of the initialization) by running
tail -n 1000 -f bin/launch-code-server-*
# Note: You can use Ctrl + C (on Mac) to get out of this view

# Once it's finished, proceed to the next steps
```

At this point switch over to your local machine and open a new terminal 

```bash
# Paste the SSH command outputted by the code-server initialiation, it will be something like this
ssh -L ${CODE_SERVER_PORT}:${COMPUTE_NODE}:${CODE_SERVER_PORT} ${USER}@ilogin.ibex.kaust.edu.sa 
```

Do not close this terminal. If you do the code-server session will stop running. Move it to the background somewhere or minimize the window.

Now open a browser on your local machine.

```bash
# In your browser, paste the URL generated by the code-server initialiation, it will be something like this
localhost:${CODE_SERVER_PORT}/?folder=${PROJECT_DIR}
```

Now you should be able to have a VSCode-like view of your IBEX directory through your browser window. Any files or work you do here are directly saved on the IBEX.

## Running a job on IBEX

Jobs on IBEX should be executed using the SLURM job scheduler. The best way to do this is to put the program you want to execute inside the `launch-job.sbatch` script. Modify the resource requirements for the job at the top of the script and add the commands needed to execute your job at the bottom of your script. You can use this tool to help you configure your jobs https://www.hpc.kaust.edu.sa/ibex/job.
Once your job file is finished, run it as follows:

```bash
sbatch launch-job.sbatch
```

You can monitor your job using `squeue`

```bash
# Monitor your SLURM process to see when your job starts running
watch -d -n 10 squeue -u YOUR_IBEX_USERNAME
# Note: You can use Ctrl + C (on Mac) to get out of this view
```

**Note:** Jobs should only be submitted on *login nodes* on IBEX. It's often tempting to run all your jobs from code-server because that's where you'll be doing most of your work, but in order to get code-server up and running you had to run the initialization through a job so code-server is running on a *compute node*. The way I like to do my workflow is to have a split screen of my code-server window and my terminal. On code-server is where I write all my programs and configurations, and on the terminal is where I execute the jobs when I'm ready.

Example: 

![IBEX working environment](https://i.imgur.com/hNDYT1c.jpg)



## Backing up your code-server extensions

This repository contains all the files for the extensions I downloaded for use on code-server on the KAUST IBEX https://github.com/mpampuch/ibex-code-server-extensions-backup.

Code server extensions are really helpful for a variety of tasks and make writing programs less tedius and less error-prone. In this repository I've curated the most essential ones in my opinion so far for performing work on code-server. 

When initializing code-server on the IBEX from a new project folder, sometimes your extensions don't get saved to this new code-server instance. It would be very annoying to have to re-install every single extension you downloaded from a previous instance every single time you open up code-server so as a work-around I've created a backup folder with all the extension files so that you can just import them all with one command. 

This is how I recommend doing it.

### Copy the extension backups into your home folder

Your IBEX home directory stores is found at `/home/YOUR_KAUST_USERNAME`. No work is supposed to be done here, but it is a good place for storing configuration files. I would recommend cloning these extensions to your home directory and storing them there.

```bash
# Change into your home directory
cd /home/YOUR_KAUST_USERNAME # or just do cd ~

# Clone this repository into your home directory
git pull https://github.com/mpampuch/ibex-code-server-extensions-backup
# You may have to run module load git if you don't have git activated
```

### Import the extensions into your project

In order for code-server to read your extensions, they have to be in this folder `/ibex/user/YOUR_KAUST_USERNAME/YOUR_PROJECT_NAME/env/share/code-server/extensions/`
- In order to have the `env` folder, make sure you have created a conda environment using the instructions found above.

If this folder is empty or your extensions aren't loading in your code-server, run this command

```bash
# Make sure you are in your project folder before starting 
# Also make sure your extensions backup folder is in your home directory

# Copy all your extensions to your project folder
cp -rv ~/ibex-code-server-extensions-backup/* ./env/share/code-server/extensions/
```

Once this is done, launch or refresh your code-server instance and all your code-server extensions should be installed.
- Some extensions need a reload of the code-server instance, so to get all of them installed you might need to reload twice.

Now you're ready to work effectively.

### Creating a new backup

If you install any extensions whlie you're working in code-server, it's probably a good idea to back them up because there's a good chance they'll be useful to you in the future. To do this, simply do what was done previously in reverse. Copy all the files out of your code-server extensions folder and into your home directory.

```bash
# Make sure you are in your project folder before starting 
# Also make sure your extensions backup folder is in your home directory

# Copy all your extensions to your home folder
cp -rv ./env/share/code-server/extensions/* ~/ibex-code-server-extensions-backup/ 
```

Now all your backups should be up to date. From here you can pull them off the IBEX or push them to a GitHub repository if you want extra security.

## Activating RStudio Server

Eventually you will need to use R to analyze some data. The only viable way to use R is within RStudio. In order to get access to RStudio but have it run on the IBEX use the following instructions.

```bash
# Make sure you are in your project folder before starting

# Activate your conda environment
conda activate "$(pwd)/env"

# Run the script to launch RStudio Server
sbatch bin/launch-rstudio-server.sbatch

# Monitor your SLURM process until your job starts running
watch -d -n 10 squeue -u YOUR_IBEX_USERNAME
# Once your job is running, continue with the following steps
# Note: You can use Ctrl + C (on Mac) to get out of this view

# RStudio Server should now be activating. This could take upwards of 10 minutes. Monitor it (and view the output of the initialization) by running
tail -n 1000 -f bin/launch-rstudio-server-*
# Note: You can use Ctrl + C (on Mac) to get out of this view

# Once it's finished, proceed to the next steps
```

At this point switch over to your local machine and open a new terminal 

```bash
# Paste the SSH command outputted by the RStudio Server initialiation, it will be something like this
ssh -L ${PORT}:${HOSTNAME}:${PORT} ${SINGULARITYENV_USER}@ilogin.ibex.kaust.edu.sa
```

Do not close this terminal. If you do the RStudio Server session will stop running. Move it to the background somewhere or minimize the window.

Now open a browser on your local machine.

```bash
# In your browser, paste the URL generated by the RStudio Server initialiation, it will be something like this
http://localhost:${PORT}
```

You should be redirected to RStudio Server.

RStudio Server requires you to be authenticated. The credentials should be in the RStudio Server initialiation output

```bash
user: KAUST_USERNAME
password: RANDOMLY_GENERATED_PASSWORD
```

After this you should finally be in RStudio on the IBEX (viewed in your browser). Before you can start doing any work, make sure to enter the following command in the R Console.

```R
setwd("/mnt")
```

And in the `Files` pane, click on  `More` (the gear icon) -> `Go To Working Directory`

Now you're finally ready to begin working in RStudio Server. You can now access all the data you have in your project folder on IBEX and any files you create will automatically appear in this folder.

NOTE: If you are creating a new R project from RStudio Server, make sure you create the project as a subdirectory of /mnt
